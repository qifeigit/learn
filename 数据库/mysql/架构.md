# 架构

## 连接层

每个客户端连接都有一线程，并会对连接做验证。

## 解析层

mysql会解析查询和做优化，包括重写查询，决定表的读取顺序，选择合适的索引。

用户可以通过特殊的关键字提示优化器？

可以使用explain查看。

优化器会请求存储引擎的相关的信息，来优化操作

##  存储层



## 事务

脏读

读了一个未提交的事务



不可重复读

在这个事务执行过程中，读取的数据不一致



幻读

多出了几行

解决方案-next-lock

## 何为幻读

脏读、不可重复读、可重复读、幻读，其中最难理解的是幻读

以mysql为例：

**幻读在可重复读的模式下才会出现，其他隔离级别中不会出现**

幻读现象例子：
可重复读模式下，比如有个用户表，手机号码为主键，有两个事物进行如下操作

事务A操作如下：
1、打开事务
2、查询号码为X的记录，不存在
3、插入号码为X的数据，插入报错（为什么会报错，先向下看）
4、查询号码为X的记录，发现还是不存在（由于是可重复读，所以读取记录X还是不存在的）

事物B操作：在事务A第2步操作时插入了一条X的记录，所以会导致A中第3步插入报错（违反了唯一约束）

上面操作对A来说就像发生了幻觉一样，明明查询X（A中第二步、第四步）不存在，但却无法插入成功

幻读可以这么理解：事务中后面的操作（插入号码X）需要上面的读取操作（查询号码X的记录）提供支持，但读取操作却不能支持下面的操作时产生的错误，就像发生了幻觉一样。



# 并发



## 锁

共享锁



排他锁





间隙锁-锁住几个行之间的范围

